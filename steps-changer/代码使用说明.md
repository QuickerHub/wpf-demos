# Zepp Life 步数修改代码使用说明

## 代码结构分析

### Python 脚本（`src/zepp-life-step-mimotion/`）

1. **`zepp加密getaccess.py`**
   - **功能**: 登录获取 access token
   - **输入**: 账号（邮箱或手机号）、密码
   - **输出**: access token 和账号类型（email/huami_phone）
   - **核心函数**: `getAccess_with_pycurl(username, password)`
   - **对应 C# 实现**: `ZeppAuthService.GetAccessTokenAsync()`

2. **`zepp注册接口.py`**
   - **功能**: 注册新账号
   - **需要**: 验证码、邮箱/手机号、密码
   - **注意**: 需要先下载验证码图片，用户手动输入验证码

3. **`第三方绑定接口.py`**
   - **功能**: 绑定支付宝账号到 Zepp
   - **流程**:
     1. 获取支付宝授权 URL (`test_band_v2`)
     2. 模拟支付宝授权流程 (`moni_alipay`, `simulate_auth_post`)
     3. 绑定支付宝账号 (`bind_alipay_account`)
   - **对应 C# 实现**: `AlipayBindingService`

### C# 服务类（`src/StepsChanger/Services/`）

1. **`ZeppAuthService.cs`**
   - 登录获取 access token
   - 测试 apptoken 是否有效

2. **`AlipayBindingService.cs`**
   - 获取支付宝授权 URL
   - 模拟支付宝授权流程
   - 绑定支付宝账号

3. **`StepsService.cs`** (新创建)
   - 整合所有功能的主服务
   - 提供 `ChangeStepsAsync()` 方法

## 使用方法

### 方法 1: 使用 Runner.ChangeSteps()（推荐）

```csharp
var (success, error) = await Runner.ChangeSteps("账号@qq.com", "密码", "10000");
if (success)
{
    Console.WriteLine("步数修改成功！");
}
else
{
    Console.WriteLine($"修改失败: {error}");
}
```

### 方法 2: 直接使用 StepsService

```csharp
using var stepsService = new StepsService();
var (success, error) = await stepsService.ChangeStepsAsync("账号@qq.com", "密码", 10000);
```

### 方法 3: 分步调用（更灵活）

```csharp
// 1. 登录获取 token
using var authService = new ZeppAuthService();
var (token, error) = await authService.GetAccessTokenAsync("账号@qq.com", "密码");

// 2. 获取用户信息（需要实现）
// 3. 提交步数（需要实现）
```

## 重要说明

### ⚠️ 关于步数提交

根据 `README.md` 的描述，**步数修改是通过绑定微信/支付宝来完成的**，而不是直接通过 Zepp API 提交步数。

这意味着：
1. 需要先绑定微信或支付宝账号
2. 步数的提交可能是通过第三方平台（微信/支付宝）的接口来完成的
3. 直接通过 Zepp API 提交步数的方法可能不存在或需要额外的 API 调用

### 当前实现状态

- ✅ **已完成**: 登录获取 token
- ✅ **已完成**: 绑定支付宝账号
- ⚠️ **待完善**: 获取用户信息（userid, apptoken）
- ⚠️ **待完善**: 直接提交步数的 API（可能需要通过第三方平台）

### 下一步工作

1. **验证获取用户信息的 API**
   - 需要确认如何从 access token 获取 userid 和 apptoken
   - 可能需要调用 `/v1/users/me` 或其他 API

2. **实现步数提交**
   - 如果直接 API 存在，实现 `SubmitStepsAsync()` 方法
   - 如果通过第三方平台，需要实现微信/支付宝的步数提交接口

3. **测试完整流程**
   - 登录 → 获取用户信息 → 提交步数
   - 或：登录 → 绑定第三方 → 通过第三方提交步数

## API 端点参考

- 登录: `https://api-user.zepp.com/v2/registrations/tokens`
- 用户信息: `https://api-mifit-cn3.zepp.com/v1/users/me`
- 测试 token: `https://api-mifit-cn3.zepp.com/v2/users/me/events`
- 第三方授权: `https://api-mifit-cn3.zepp.com/v1/thirdParties/auth.json`

## 注意事项

1. **Token 管理**: 频繁访问可能会遇到 429 错误，建议将 token 存储在数据库中
2. **Cookie 管理**: 支付宝授权需要有效的 cookie，需要从真实手机抓包获取
3. **账号格式**: 
   - 邮箱账号直接使用
   - 手机号需要添加 `+86` 前缀

