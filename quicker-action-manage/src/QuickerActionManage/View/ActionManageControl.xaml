<UserControl
    x:Class="QuickerActionManage.View.ActionManageControl"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:dd="urn:gong-wpf-dragdrop"
    xmlns:editor="clr-namespace:QuickerActionManage.View.Editor"
    xmlns:hc="https://handyorg.github.io/handycontrol"
    xmlns:local="clr-namespace:QuickerActionManage.View"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:qk="https://getquicker.net"
    xmlns:sys="clr-namespace:System;assembly=mscorlib"
    xmlns:viewmodel="clr-namespace:QuickerActionManage.ViewModel"
    d:DataContext="{d:DesignInstance Type=viewmodel:ActionListViewModel}"
    d:DesignHeight="300"
    d:DesignWidth="600"
    mc:Ignorable="d">
    <UserControl.Resources>
        <x:Array x:Key="testlist" Type="viewmodel:ActionItemModel">
            <viewmodel:ActionItemModel Title="哈哈哈哈" Icon="fa:Light_Times" />
            <viewmodel:ActionItemModel Title="哈哈哈哈" Icon="fa:Light_Times" />
            <viewmodel:ActionItemModel Title="哈哈哈哈" Icon="fa:Light_Times" />
        </x:Array>
    </UserControl.Resources>
    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="27*" />
            <ColumnDefinition Width="73*" />
        </Grid.ColumnDefinitions>
        <Grid.RowDefinitions>
            <RowDefinition Height="50" />
            <RowDefinition />
            <RowDefinition Height="auto" />
        </Grid.RowDefinitions>
        <DockPanel
            Grid.ColumnSpan="2"
            Margin="20,0,20,0"
            VerticalAlignment="Center">
            <Button
                Click="RefreshButton_Click"
                DockPanel.Dock="Right"
                ToolTip="当添加了新动作或者修改了动作过后点击这里刷新">
                刷新
            </Button>
            <local:PopupButtonControl DockPanel.Dock="Left" Header="筛选">
                <editor:PropertyGridPlus SelectedObject="{Binding FilterItem}" />
            </local:PopupButtonControl>
            <local:PopupButtonControl DockPanel.Dock="Left" Header="排序">
                <editor:PropertyGridPlus SelectedObject="{Binding Sorter}" />
            </local:PopupButtonControl>
            <local:PopupButtonControl
                x:Name="RefButton"
                DockPanel.Dock="Left"
                Header="引用">
                <Grid
                    Width="250"
                    MaxHeight="300"
                    Margin="1"
                    DataContext="{Binding GSModel}">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="auto" />
                        <RowDefinition />
                    </Grid.RowDefinitions>
                    <DockPanel>
                        <Button Name="GSCancel" Click="GSCancel_Click">取消</Button>
                        <TextBox Text="{Binding FilterItem.SearchText, UpdateSourceTrigger=PropertyChanged}" />
                    </DockPanel>
                    <ListBox
                        x:Name="TheSubprogramListBox"
                        Grid.Row="1"
                        ItemsSource="{Binding Subprograms}"
                        MouseLeftButtonUp="TheSubprogramListBox_MouseLeftButtonUp"
                        SelectedItem="{Binding SelectedItem}"
                        SelectionMode="Single">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <DockPanel>
                                    <qk:IconControl
                                        Width="16"
                                        Height="16"
                                        DockPanel.Dock="Left"
                                        Icon="{StaticResource GlobalSubProgramIcon}" />
                                    <TextBlock Margin="5,0" Text="{Binding Name}" />
                                </DockPanel>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </Grid>
            </local:PopupButtonControl>
            <local:PopupButtonControl
                x:Name="TheRulePop"
                DockPanel.Dock="Right"
                Header="规则">
                <StackPanel MinWidth="200">
                    <StackPanel.Resources>
                        <Style BasedOn="{StaticResource ButtonDefault}" TargetType="{x:Type Button}">
                            <Setter Property="HorizontalAlignment" Value="Stretch" />
                            <Setter Property="Margin" Value="0,5" />
                        </Style>
                    </StackPanel.Resources>
                    <Button Margin="0,3" Click="ResetRule_Click">使用默认规则</Button>
                    <ListBox
                        x:Name="TheRuleListBox"
                        MinHeight="20"
                        ItemsSource="{Binding RuleItems}"
                        PreviewMouseLeftButtonUp="TheRuleListBox_PreviewMouseLeftButtonUp"
                        SelectedItem="{Binding SelectedRule}">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Grid>
                                    <TextBlock Text="{Binding Title}" />
                                </Grid>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                        <ListBox.ItemContainerStyle>
                            <Style TargetType="ListBoxItem">
                                <Setter Property="HorizontalContentAlignment" Value="Center" />
                                <Setter Property="Padding" Value="5" />
                            </Style>
                        </ListBox.ItemContainerStyle>
                    </ListBox>
                    <Button
                        Margin="0,3"
                        Click="SaveRule_Click"
                        ToolTip="保存当前规则"
                        Visibility="{Binding SelectedRule, Converter={StaticResource Object2VisibilityReConverter}}">
                        保存当前规则
                    </Button>
                    <Button
                        Click="DeleteRule_Click"
                        Foreground="Red"
                        Opacity="0.5"
                        ToolTip="删除当前规则"
                        Visibility="{Binding SelectedRule, Converter={StaticResource Object2VisibilityConverter}}">
                        删除当前规则
                    </Button>
                </StackPanel>
            </local:PopupButtonControl>
            <TextBox
                x:Name="RuleNameBox"
                MinWidth="30"
                DockPanel.Dock="Right"
                Text="{Binding SelectedRule.Title}"
                Visibility="{Binding SelectedRule, Converter={StaticResource Object2VisibilityConverter}}" />
            <TextBox Text="{Binding FilterItem.SearchText, UpdateSourceTrigger=PropertyChanged}" />
        </DockPanel>

        <ListView
            Name="TheListView"
            Grid.Row="1"
            Grid.RowSpan="2"
            Grid.ColumnSpan="2"
            Margin="0,0,0,22"
            d:ItemsSource="{StaticResource testlist}"
            dd:DragDrop.IsDragSource="False"
            dd:DragDrop.IsDropTarget="False"
            BorderThickness="0"
            ItemsSource="{Binding ActionItems}"
            MouseDoubleClick="TheListView_MouseDoubleClick"
            PreviewMouseRightButtonUp="TheListView_PreviewMouseRightButtonUp"
            SelectedItem="{Binding SelectedItem}"
            SelectionMode="Extended">
            <ListView.ContextMenu>
                <ContextMenu>
                    <ContextMenu.Resources>
                        <Style TargetType="qk:IconControl">
                            <Setter Property="DefaultIconColor" Value="{StaticResource DefaultMenuIconColorString}" />
                        </Style>
                    </ContextMenu.Resources>
                </ContextMenu>
            </ListView.ContextMenu>
            <ListView.View>
                <GridView x:Name="TheGridView" AllowsColumnReorder="true">
                    <GridViewColumn Width="auto" Header="图标">
                        <GridViewColumn.CellTemplate>
                            <DataTemplate>
                                <Border HorizontalAlignment="Center">
                                    <qk:IconControl
                                        Width="16"
                                        Height="16"
                                        HorizontalAlignment="Center"
                                        Icon="{Binding Icon}" />
                                </Border>
                            </DataTemplate>
                        </GridViewColumn.CellTemplate>
                    </GridViewColumn>
                    <GridViewColumn
                        Width="auto"
                        DisplayMemberBinding="{Binding Title}"
                        Header="标题">
                        <GridViewColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock
                                    Text="{Binding}"
                                    ToolTip="{Binding}"
                                    ToolTipService.InitialShowDelay="500" />
                            </DataTemplate>
                        </GridViewColumn.CellTemplate>
                    </GridViewColumn>
                    <GridViewColumn Width="100" DisplayMemberBinding="{Binding Description}">
                        <GridViewColumnHeader>
                            描述
                        </GridViewColumnHeader>
                    </GridViewColumn>
                    <GridViewColumn
                        Width="auto"
                        DisplayMemberBinding="{Binding SizeKb, StringFormat='{}{0:0.00} kb'}"
                        Header="大小" />
                    <GridViewColumn
                        Width="auto"
                        DisplayMemberBinding="{Binding ExeName}"
                        Header="进程" />
                    <GridViewColumn
                        Width="auto"
                        DisplayMemberBinding="{Binding LastEditTime, Converter={StaticResource DateTimeShortConverter}}"
                        Header="最后编辑" />
                    <GridViewColumn
                        Width="auto"
                        DisplayMemberBinding="{Binding ShareTime, Converter={StaticResource DateTimeShortConverter}}"
                        Header="最后分享" />
                    <GridViewColumn
                        Width="auto"
                        DisplayMemberBinding="{Binding CreateTime, Converter={StaticResource DateTimeShortConverter}}"
                        Header="创建时间" />
                    <GridViewColumn
                        Width="auto"
                        DisplayMemberBinding="{Binding UsageCount}"
                        Header="使用次数" />
                    <GridViewColumn Width="auto" Header="详细信息">
                        <GridViewColumn.CellTemplate>
                            <DataTemplate>
                                <local:PopupButtonControl Header="查看">
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="auto" />
                                            <RowDefinition />
                                        </Grid.RowDefinitions>
                                        <TextBlock Foreground="LightGray">双击右侧文本框复制信息</TextBlock>
                                        <editor:PropertyGridPlus
                                            Grid.Row="1"
                                            MaxWidth="500"
                                            NullValueIgnore="True"
                                            SelectedObject="{Binding}" />
                                    </Grid>
                                </local:PopupButtonControl>
                            </DataTemplate>
                        </GridViewColumn.CellTemplate>
                    </GridViewColumn>
                    <GridViewColumn Width="auto" Header="运行">
                        <GridViewColumn.CellTemplate>
                            <DataTemplate>
                                <local:PopupButtonControl Header="运行">
                                    <StackPanel
                                        Width="150"
                                        Margin="1"
                                        DataContext="{Binding Runner}">
                                        <Button HorizontalAlignment="Stretch" Click="RunAction">直接运行</Button>
                                        <Button HorizontalAlignment="Stretch" Click="DebugAction">调试运行</Button>
                                        <TextBlock Margin="0,5">运行参数</TextBlock>
                                        <TextBox
                                            VerticalContentAlignment="Top"
                                            AcceptsReturn="True"
                                            MaxLines="10"
                                            MinLines="2"
                                            Text="{Binding Param, UpdateSourceTrigger=PropertyChanged}" />
                                    </StackPanel>
                                </local:PopupButtonControl>
                            </DataTemplate>
                        </GridViewColumn.CellTemplate>
                    </GridViewColumn>
                </GridView>
            </ListView.View>
        </ListView>
        <Border
            Grid.Row="2"
            Grid.ColumnSpan="2"
            Margin="0,15,0,0"
            BorderBrush="Black"
            BorderThickness="0,0.5,0,0">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition />
                    <ColumnDefinition Width="auto" />
                </Grid.ColumnDefinitions>
                <WrapPanel Margin="5,3">
                    <WrapPanel.Resources>
                        <Style TargetType="TextBlock">
                            <Setter Property="Margin" Value="5,0" />
                        </Style>
                    </WrapPanel.Resources>
                    <TextBlock Text="{Binding FilterItem.Summary}" />
                    <TextBlock Text="{Binding Sorter.Summary}" />
                    <TextBlock Text="{Binding GSModel.SelectedItem.Name, StringFormat='引用公共子程序:{0}'}" Visibility="{Binding GSModel.SelectedItem, Converter={StaticResource Object2VisibilityConverter}}" />
                    <TextBlock Text="{Binding ElementName=TheListView, Path=Items.Count, StringFormat='总计:{0}'}" />
                </WrapPanel>
                <WrapPanel Grid.Column="1" HorizontalAlignment="Right">
                    <WrapPanel.Resources>
                        <Style BasedOn="{StaticResource ButtonCustom}" TargetType="Button">
                            <Setter Property="hc:BackgroundSwitchElement.MouseDownBackground" Value="{StaticResource RegionBrush}" />
                            <Setter Property="hc:BackgroundSwitchElement.MouseHoverBackground" Value="{StaticResource SecondaryRegionBrush}" />
                            <Setter Property="Margin" Value="1" />
                            <Setter Property="FocusVisualStyle" Value="{x:Null}" />
                            <Setter Property="Padding" Value="5,0" />
                            <Setter Property="VerticalAlignment" Value="Center" />
                        </Style>
                    </WrapPanel.Resources>
                    <Button Click="Button_Click">
                        <TextBlock>用量统计</TextBlock>
                    </Button>
                    <Button Grid.Column="1" Click="RecycleButton_Click">
                        <DockPanel>
                            <qk:IconControl
                                Width="16"
                                Height="16"
                                Margin="3,0"
                                Icon="fa:Light_Recycle" />
                            <TextBlock>动作回收站</TextBlock>
                        </DockPanel>
                    </Button>
                </WrapPanel>
            </Grid>
        </Border>
    </Grid>
</UserControl>

