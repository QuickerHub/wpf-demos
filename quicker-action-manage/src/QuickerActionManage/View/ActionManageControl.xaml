<UserControl
    x:Class="QuickerActionManage.View.ActionManageControl"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:dd="urn:gong-wpf-dragdrop"
    xmlns:editor="clr-namespace:QuickerActionManage.View.Editor"
    xmlns:hc="https://handyorg.github.io/handycontrol"
    xmlns:local="clr-namespace:QuickerActionManage.View"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:qk="https://getquicker.net"
    xmlns:sys="clr-namespace:System;assembly=mscorlib"
    xmlns:viewmodel="clr-namespace:QuickerActionManage.ViewModel"
    xmlns:converters="clr-namespace:QuickerActionManage.View.Converters"
    d:DataContext="{d:DesignInstance Type=viewmodel:ActionListViewModel}"
    d:DesignHeight="300"
    d:DesignWidth="600"
    mc:Ignorable="d">
    <UserControl.Resources>
        <x:Array x:Key="testlist" Type="viewmodel:ActionItemModel">
            <viewmodel:ActionItemModel Title="哈哈哈哈" Icon="fa:Light_Times" />
            <viewmodel:ActionItemModel Title="哈哈哈哈" Icon="fa:Light_Times" />
            <viewmodel:ActionItemModel Title="哈哈哈哈" Icon="fa:Light_Times" />
        </x:Array>
    </UserControl.Resources>
    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="300" />
        </Grid.ColumnDefinitions>
        <Grid.RowDefinitions>
            <RowDefinition Height="50" />
            <RowDefinition />
            <RowDefinition Height="auto" />
            <RowDefinition Height="auto" />
        </Grid.RowDefinitions>
        
        <!-- 顶部工具栏 -->
        <DockPanel
            Grid.ColumnSpan="2"
            Margin="20,0,20,0"
            VerticalAlignment="Center">
            <Button
                Click="RefreshButton_Click"
                DockPanel.Dock="Right"
                ToolTip="当添加了新动作或者修改了动作过后点击这里刷新">
                刷新
            </Button>
            <local:PopupButtonControl
                x:Name="RefButton"
                DockPanel.Dock="Left"
                Header="引用">
                <Grid
                    Width="250"
                    MaxHeight="300"
                    Margin="1"
                    DataContext="{Binding GSModel}">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="auto" />
                        <RowDefinition />
                    </Grid.RowDefinitions>
                    <DockPanel>
                        <Button Name="GSCancel" Click="GSCancel_Click">取消</Button>
                        <TextBox Text="{Binding FilterItem.SearchText, UpdateSourceTrigger=PropertyChanged}" />
                    </DockPanel>
                    <ListBox
                        x:Name="TheSubprogramListBox"
                        Grid.Row="1"
                        ItemsSource="{Binding Subprograms}"
                        MouseLeftButtonUp="TheSubprogramListBox_MouseLeftButtonUp"
                        SelectedItem="{Binding SelectedItem}"
                        SelectionMode="Single">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <DockPanel>
                                    <qk:IconControl
                                        Width="16"
                                        Height="16"
                                        DockPanel.Dock="Left"
                                        Icon="{StaticResource GlobalSubProgramIcon}" />
                                    <TextBlock Margin="5,0" Text="{Binding Name}" />
                                </DockPanel>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </Grid>
            </local:PopupButtonControl>
            <TextBox Text="{Binding FilterItem.SearchText, UpdateSourceTrigger=PropertyChanged}" />
        </DockPanel>

        <!-- 左侧：动作列表 -->
        <ListView
            Name="TheListView"
            Grid.Row="1"
            Grid.Column="0"
            Margin="0,0,0,0"
            d:ItemsSource="{StaticResource testlist}"
            dd:DragDrop.IsDragSource="False"
            dd:DragDrop.IsDropTarget="False"
            BorderThickness="0"
            ItemsSource="{Binding ActionItems}"
            MouseDoubleClick="TheListView_MouseDoubleClick"
            PreviewMouseRightButtonUp="TheListView_PreviewMouseRightButtonUp"
            SelectedItem="{Binding SelectedItem}"
            SelectionMode="Extended">
            <ListView.ContextMenu>
                <ContextMenu>
                    <ContextMenu.Resources>
                        <Style TargetType="qk:IconControl">
                            <Setter Property="DefaultIconColor" Value="{StaticResource DefaultMenuIconColorString}" />
                        </Style>
                    </ContextMenu.Resources>
                </ContextMenu>
            </ListView.ContextMenu>
            <ListView.View>
                <GridView x:Name="TheGridView" AllowsColumnReorder="true">
                    <GridViewColumn Width="auto" Header="图标">
                        <GridViewColumn.CellTemplate>
                            <DataTemplate>
                                <Border HorizontalAlignment="Center">
                                    <qk:IconControl
                                        Width="16"
                                        Height="16"
                                        HorizontalAlignment="Center"
                                        Icon="{Binding Icon}" />
                                </Border>
                            </DataTemplate>
                        </GridViewColumn.CellTemplate>
                    </GridViewColumn>
                    <GridViewColumn
                        Width="auto"
                        DisplayMemberBinding="{Binding Title}"
                        Header="标题">
                        <GridViewColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock
                                    Text="{Binding}"
                                    ToolTip="{Binding}"
                                    ToolTipService.InitialShowDelay="500" />
                            </DataTemplate>
                        </GridViewColumn.CellTemplate>
                    </GridViewColumn>
                    <GridViewColumn Width="100" DisplayMemberBinding="{Binding Description}">
                        <GridViewColumnHeader>
                            描述
                        </GridViewColumnHeader>
                    </GridViewColumn>
                    <GridViewColumn
                        Width="auto"
                        DisplayMemberBinding="{Binding SizeKb, StringFormat='{}{0:0.00} kb'}"
                        Header="大小" />
                    <GridViewColumn
                        Width="auto"
                        DisplayMemberBinding="{Binding ExeName}"
                        Header="进程" />
                    <GridViewColumn
                        Width="auto"
                        DisplayMemberBinding="{Binding LastEditTime, Converter={StaticResource DateTimeShortConverter}}"
                        Header="最后编辑" />
                    <GridViewColumn
                        Width="auto"
                        DisplayMemberBinding="{Binding ShareTime, Converter={StaticResource DateTimeShortConverter}}"
                        Header="最后分享" />
                    <GridViewColumn
                        Width="auto"
                        DisplayMemberBinding="{Binding CreateTime, Converter={StaticResource DateTimeShortConverter}}"
                        Header="创建时间" />
                    <GridViewColumn
                        Width="auto"
                        DisplayMemberBinding="{Binding UsageCount}"
                        Header="使用次数" />
                    <GridViewColumn Width="auto" Header="详细信息">
                        <GridViewColumn.CellTemplate>
                            <DataTemplate>
                                <local:PopupButtonControl Header="查看">
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="auto" />
                                            <RowDefinition />
                                        </Grid.RowDefinitions>
                                        <TextBlock Foreground="LightGray">双击右侧文本框复制信息</TextBlock>
                                        <editor:PropertyGridPlus
                                            Grid.Row="1"
                                            MaxWidth="500"
                                            SelectedObject="{Binding}" />
                                    </Grid>
                                </local:PopupButtonControl>
                            </DataTemplate>
                        </GridViewColumn.CellTemplate>
                    </GridViewColumn>
                    <GridViewColumn Width="auto" Header="运行">
                        <GridViewColumn.CellTemplate>
                            <DataTemplate>
                                <local:PopupButtonControl Header="运行">
                                    <StackPanel
                                        Width="150"
                                        Margin="1"
                                        DataContext="{Binding Runner}">
                                        <Button HorizontalAlignment="Stretch" Click="RunAction">直接运行</Button>
                                        <Button HorizontalAlignment="Stretch" Click="DebugAction">调试运行</Button>
                                        <TextBlock Margin="0,5">运行参数</TextBlock>
                                        <TextBox
                                            VerticalContentAlignment="Top"
                                            AcceptsReturn="True"
                                            MaxLines="10"
                                            MinLines="2"
                                            Text="{Binding Param, UpdateSourceTrigger=PropertyChanged}" />
                                    </StackPanel>
                                </local:PopupButtonControl>
                            </DataTemplate>
                        </GridViewColumn.CellTemplate>
                    </GridViewColumn>
                </GridView>
            </ListView.View>
        </ListView>
        
        <!-- 分组选择区域 -->
        <Border
            Grid.Row="2"
            Grid.Column="0"
            Margin="0,5,0,0"
            BorderBrush="LightGray"
            BorderThickness="0,1,0,0"
            Padding="5,5,5,5">
            <StackPanel Orientation="Horizontal">
                <TextBlock
                    VerticalAlignment="Center"
                    Margin="0,0,10,0"
                    Text="分组：" />
                <ListBox
                    x:Name="TheGroupListBox"
                    BorderThickness="0"
                    Background="Transparent"
                    ItemsSource="{Binding GroupManager.Groups}"
                    PreviewMouseLeftButtonUp="TheGroupListBox_PreviewMouseLeftButtonUp"
                    SelectedItem="{Binding SelectedGroup, Mode=TwoWay}"
                    SelectionMode="Single">
                    <ListBox.ItemsPanel>
                        <ItemsPanelTemplate>
                            <WrapPanel Orientation="Horizontal" />
                        </ItemsPanelTemplate>
                    </ListBox.ItemsPanel>
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <local:EditableTextBlock
                                Text="{Binding Name, Mode=TwoWay}"
                                FontSize="13"
                                CanEdit="{Binding CanEdit}" />
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                    <ListBox.ItemContainerStyle>
                        <Style TargetType="ListBoxItem" BasedOn="{StaticResource SelectableListBoxItemStyle}" />
                    </ListBox.ItemContainerStyle>
                    <ListBox.ContextMenu>
                        <ContextMenu>
                            <MenuItem 
                                Header="删除分组" 
                                Click="DeleteGroupMenuItem_Click" 
                                IsEnabled="{Binding SelectedGroup.CanEdit}" />
                        </ContextMenu>
                    </ListBox.ContextMenu>
                </ListBox>
                <Button
                    Margin="4,0,0,0"
                    Click="AddGroupButton_Click"
                    ToolTip="添加分组"
                    VerticalAlignment="Center">
                    <Button.Style>
                        <Style TargetType="Button" BasedOn="{StaticResource ButtonDefault}">
                            <Setter Property="Background" Value="{DynamicResource RegionBrush}" />
                            <Setter Property="Foreground" Value="{DynamicResource PrimaryTextBrush}" />
                            <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}" />
                            <Setter Property="BorderThickness" Value="1" />
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="Button">
                                        <Border
                                            x:Name="Bd"
                                            Background="{TemplateBinding Background}"
                                            BorderBrush="{TemplateBinding BorderBrush}"
                                            BorderThickness="{TemplateBinding BorderThickness}"
                                            CornerRadius="6"
                                            Padding="{TemplateBinding Padding}"
                                            SnapsToDevicePixels="True">
                                            <ContentPresenter
                                                HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                                VerticalAlignment="{TemplateBinding VerticalContentAlignment}"
                                                SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}" />
                                        </Border>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter TargetName="Bd" Property="Background" Value="{DynamicResource SecondaryRegionBrush}" />
                                                <Setter TargetName="Bd" Property="BorderBrush" Value="{DynamicResource PrimaryBrush}" />
                                            </Trigger>
                                            <Trigger Property="IsPressed" Value="True">
                                                <Setter TargetName="Bd" Property="Background" Value="{DynamicResource PrimaryBrush}" />
                                                <Setter TargetName="Bd" Property="BorderBrush" Value="{DynamicResource PrimaryBrush}" />
                                                <Setter Property="Foreground" Value="White" />
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </Button.Style>
                    <qk:IconControl
                        Width="16"
                        Height="16"
                        Icon="fa:Light_Plus" />
                </Button>
            </StackPanel>
        </Border>
        
        <!-- 右侧：规则和筛选区域 -->
        <Border
            Grid.Row="1"
            Grid.Column="1"
            Margin="5,0,0,0"
            BorderBrush="LightGray"
            BorderThickness="1">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>
                
                <!-- 规则区域 -->
                <GroupBox Grid.Row="0" Header="规则" Margin="5">
                    <StackPanel>
                        <!-- 按钮区域 -->
                        <WrapPanel Margin="0,0,0,8">
                            <WrapPanel.Resources>
                                <Style BasedOn="{StaticResource ButtonDefault}" TargetType="{x:Type Button}">
                                    <Setter Property="Margin" Value="3,0" />
                                    <Setter Property="HorizontalAlignment" Value="Left" />
                                    <Setter Property="HorizontalContentAlignment" Value="Center" />
                                    <Setter Property="Padding" Value="12,6" />
                                    <Setter Property="MinWidth" Value="60" />
                                </Style>
                            </WrapPanel.Resources>
                            <Button Click="AddRule_Click">添加</Button>
                            <Button
                                Click="DeleteRule_Click"
                                Foreground="Red"
                                Opacity="0.7"
                                ToolTip="删除当前规则"
                                IsEnabled="{Binding SelectedRule, Converter={StaticResource ObjectToBoolConverter}}">
                                删除
                            </Button>
                        </WrapPanel>
                        <!-- 规则列表 -->
                        <Border
                            BorderBrush="#E0E0E0"
                            BorderThickness="1"
                            Background="White"
                            CornerRadius="3"
                            Padding="5">
                            <ListBox
                                x:Name="TheRuleListBox"
                                MinHeight="30"
                                MaxHeight="150"
                                BorderThickness="0"
                                Background="Transparent"
                                ItemsSource="{Binding RuleItems}"
                                PreviewMouseLeftButtonUp="TheRuleListBox_PreviewMouseLeftButtonUp"
                                SelectionChanged="TheRuleListBox_SelectionChanged"
                                SelectedItem="{Binding SelectedRule, Mode=TwoWay}"
                                SelectionMode="Single">
                                <ListBox.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <WrapPanel Orientation="Horizontal" />
                                    </ItemsPanelTemplate>
                                </ListBox.ItemsPanel>
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <local:EditableTextBlock
                                            Text="{Binding Title, Mode=TwoWay}"
                                            FontSize="13">
                                            <local:EditableTextBlock.IsEditing>
                                                <MultiBinding Converter="{StaticResource EqualityToBoolConverter}">
                                                    <Binding Path="ViewModel.EditingRule" RelativeSource="{RelativeSource AncestorType=UserControl}" />
                                                    <Binding />
                                                </MultiBinding>
                                            </local:EditableTextBlock.IsEditing>
                                        </local:EditableTextBlock>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                                <ListBox.ItemContainerStyle>
                                    <Style TargetType="ListBoxItem" BasedOn="{StaticResource SelectableListBoxItemStyle}">
                                        <EventSetter Event="MouseDoubleClick" Handler="RuleListBoxItem_MouseDoubleClick" />
                                    </Style>
                                </ListBox.ItemContainerStyle>
                                <ListBox.ContextMenu>
                                    <ContextMenu>
                                        <MenuItem Header="重命名" Click="RenameRuleMenuItem_Click" />
                                    </ContextMenu>
                                </ListBox.ContextMenu>
                            </ListBox>
                        </Border>
                    </StackPanel>
                </GroupBox>
                
                <!-- 排序区域 -->
                <GroupBox Grid.Row="1" Header="排序" Margin="5,5,5,5">
                    <editor:PropertyGridPlus
                        Margin="0"
                        SelectedObject="{Binding CurrentRule.Sorter}" />
                </GroupBox>
                
                <!-- 筛选区域 -->
                <GroupBox Grid.Row="2" Header="筛选" Margin="5,5,5,5">
                    <editor:PropertyGridPlus
                        Margin="0"
                        SelectedObject="{Binding CurrentRule.FilterItem}" />
                </GroupBox>
            </Grid>
        </Border>
        
        <Border
            Grid.Row="3"
            Grid.Column="0"
            Margin="0,5,0,0"
            BorderBrush="Black"
            BorderThickness="0,0.5,0,0">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition />
                    <ColumnDefinition Width="auto" />
                </Grid.ColumnDefinitions>
                <WrapPanel Margin="5,3">
                    <WrapPanel.Resources>
                        <Style TargetType="TextBlock">
                            <Setter Property="Margin" Value="5,0" />
                        </Style>
                    </WrapPanel.Resources>
                    <TextBlock Text="{Binding FilterItem.Summary}" />
                    <TextBlock Text="{Binding Sorter.Summary}" />
                    <TextBlock Text="{Binding GSModel.SelectedItem.Name, StringFormat='引用公共子程序:{0}'}" Visibility="{Binding GSModel.SelectedItem, Converter={StaticResource Object2VisibilityConverter}}" />
                    <TextBlock Text="{Binding ElementName=TheListView, Path=Items.Count, StringFormat='总计:{0}'}" />
                </WrapPanel>
                <WrapPanel Grid.Column="1" HorizontalAlignment="Right">
                    <WrapPanel.Resources>
                        <Style BasedOn="{StaticResource ButtonCustom}" TargetType="Button">
                            <Setter Property="hc:BackgroundSwitchElement.MouseDownBackground" Value="{StaticResource RegionBrush}" />
                            <Setter Property="hc:BackgroundSwitchElement.MouseHoverBackground" Value="{StaticResource SecondaryRegionBrush}" />
                            <Setter Property="Margin" Value="1" />
                            <Setter Property="FocusVisualStyle" Value="{x:Null}" />
                            <Setter Property="Padding" Value="5,0" />
                            <Setter Property="VerticalAlignment" Value="Center" />
                        </Style>
                    </WrapPanel.Resources>
                    <Button Click="Button_Click">
                        <TextBlock>用量统计</TextBlock>
                    </Button>
                    <Button Grid.Column="1" Click="RecycleButton_Click">
                        <DockPanel>
                            <qk:IconControl
                                Width="16"
                                Height="16"
                                Margin="3,0"
                                Icon="fa:Light_Recycle" />
                            <TextBlock>动作回收站</TextBlock>
                        </DockPanel>
                    </Button>
                </WrapPanel>
            </Grid>
        </Border>
    </Grid>
</UserControl>

