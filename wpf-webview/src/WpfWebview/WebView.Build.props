<Project>
  <!--
    WebView Build Configuration
    This file provides unified build configuration for WPF projects with WebView integration.
    
    Usage:
    1. Import this file in your .csproj:
       <Import Project="WebView.Build.props" />
    
    2. Set WebProjectPath property (relative to this file):
       <PropertyGroup>
         <WebProjectPath>$(MSBuildThisFileDirectory)..\YourWebProject</WebProjectPath>
       </PropertyGroup>
    
    3. Optional: Override default values:
       <PropertyGroup>
         <WebPackageManager>pnpm</WebPackageManager>
         <WebBuildCommand>build</WebBuildCommand>
         <WebDevServerPort>5173</WebDevServerPort>
       </PropertyGroup>
  -->

  <PropertyGroup>
    <!-- Default values -->
    <WebPackageManager>pnpm</WebPackageManager>
    <WebBuildCommand>build</WebBuildCommand>
    <WebDevServerPort>5173</WebDevServerPort>
    <WebDistPath>$(WebProjectPath)\dist</WebDistPath>
    <WebDevServerInfoFile>.vite-dev-server</WebDevServerInfoFile>
  </PropertyGroup>

  <!-- WebView2 NuGet package -->
  <ItemGroup>
    <PackageReference Include="Microsoft.Web.WebView2" Version="1.0.3240.44" />
  </ItemGroup>

  <!-- Build web project before building WPF project (Release only) -->
  <Target Name="BuildWebProject" BeforeTargets="BeforeBuild" Condition="'$(Configuration)' == 'Release' AND '$(WebProjectPath)' != ''">
    <Message Text="Building web project for production..." Importance="high" />
    
    <!-- Install dependencies if node_modules doesn't exist -->
    <Exec Command="$(WebPackageManager) install" 
          WorkingDirectory="$(WebProjectPath)" 
          Condition="!Exists('$(WebProjectPath)\node_modules')" 
          ContinueOnError="true" />
    
    <!-- Build web project -->
    <Exec Command="$(WebPackageManager) $(WebBuildCommand)" 
          WorkingDirectory="$(WebProjectPath)" 
          ContinueOnError="false" />
    
    <Message Text="Web project build completed." Importance="high" />
  </Target>

  <!-- Copy web dist files to output directory/Web folder -->
  <Target Name="CopyWebFiles" AfterTargets="Build" Condition="Exists('$(WebDistPath)')">
    <PropertyGroup>
      <WebOutputDir>$(TargetDir)Web</WebOutputDir>
    </PropertyGroup>
    
    <!-- Delete existing Web folder before copying -->
    <RemoveDir Directories="$(WebOutputDir)" />
    
    <!-- Copy entire dist folder to Web folder -->
    <ItemGroup>
      <WebFiles Include="$(WebDistPath)\**\*.*" />
    </ItemGroup>
    
    <Copy SourceFiles="@(WebFiles)" 
          DestinationFolder="$(WebOutputDir)\%(RecursiveDir)" />
  </Target>

  <!-- Copy dev server info file to output directory/Web folder (Debug mode only) -->
  <Target Name="CopyDevServerInfoFile" AfterTargets="Build" Condition="'$(Configuration)' == 'Debug' AND '$(WebProjectPath)' != ''">
    <PropertyGroup>
      <DevServerInfoSourcePath>$(WebProjectPath)\$(WebDevServerInfoFile)</DevServerInfoSourcePath>
      <DevServerInfoTargetPath>$(TargetDir)Web\$(WebDevServerInfoFile)</DevServerInfoTargetPath>
    </PropertyGroup>
    
    <Copy SourceFiles="$(DevServerInfoSourcePath)" 
          DestinationFiles="$(DevServerInfoTargetPath)" 
          Condition="Exists('$(DevServerInfoSourcePath)')"
          SkipUnchangedFiles="true" />
  </Target>
</Project>
