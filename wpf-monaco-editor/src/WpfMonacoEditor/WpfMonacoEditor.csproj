<Project Sdk="Microsoft.NET.Sdk">
	<!-- Default project properties -->
	<PropertyGroup>
		<OutputType>WinExe</OutputType>
		<TargetFramework>net472</TargetFramework>
		<Nullable>enable</Nullable>
		<UseWPF>true</UseWPF>
		<LangVersion>preview</LangVersion>
		<PlatformTarget>x64</PlatformTarget>
		<Version Condition="'$(Version)' == ''">1.0.0.0</Version>
		<AssemblyName Condition="'$(Configuration)' != 'Release'">$(MSBuildProjectName)</AssemblyName>
	</PropertyGroup>

	<!-- Release configuration: Output as Library for Quicker integration -->
	<PropertyGroup Condition="'$(Configuration)' == 'Release'">
		<OutputType>Library</OutputType>
		<AssemblyName>$(MSBuildProjectName).$(Version)</AssemblyName>
		<ApplicationDefinition />
	</PropertyGroup>

	<!-- Remove App.xaml files in Release mode (not needed for library) -->
	<ItemGroup Condition="'$(Configuration)' == 'Release'">
		<Compile Remove="App.xaml.cs" />
		<Page Remove="App.xaml" />
		<ApplicationDefinition Remove="App.xaml" />
	</ItemGroup>

	<!-- Web project configuration -->
	<PropertyGroup>
		<WebProjectPath>$(MSBuildThisFileDirectory)..\WpfMonacoEditor.Web</WebProjectPath>
		<WebPackageManager>pnpm</WebPackageManager>
		<WebBuildCommand>build</WebBuildCommand>
		<WebDevServerPort>5174</WebDevServerPort>
		<WebDistPath>$(WebProjectPath)\dist</WebDistPath>
		<WebDevServerInfoFile>.vite-dev-server</WebDevServerInfoFile>
	</PropertyGroup>

	<!-- Standard NuGet packages -->
	<ItemGroup>
		<PackageReference Include="log4net" Version="2.0.15" />
		<PackageReference Include="Newtonsoft.Json" Version="13.0.3" />
		<PackageReference Include="CommunityToolkit.Mvvm" Version="8.4.0" />
		<PackageReference Include="Microsoft.Web.WebView2" Version="1.0.3240.44" />
		<PackageReference Include="DependencyPropertyGenerator" Version="1.5.0">
			<PrivateAssets>all</PrivateAssets>
			<IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
		</PackageReference>
		<PackageReference Include="Costura.Fody" Version="5.7.0" />
	</ItemGroup>

	<!-- Standard framework references -->
	<ItemGroup>
		<Reference Include="Microsoft.CSharp" />
		<Reference Include="System.Net.Http" />
	</ItemGroup>

	<!-- Quicker framework references - Import from root qkref.props -->
	<Import Project="..\..\..\qkref.props" />

	<!-- Build web project before building WPF project (Release only) -->
	<Target Name="BuildWebProject" BeforeTargets="BeforeBuild" Condition="'$(Configuration)' == 'Release' AND '$(WebProjectPath)' != ''">
		<Message Text="Building web project for production..." Importance="high" />
		
		<!-- Install dependencies if node_modules doesn't exist -->
		<Exec Command="$(WebPackageManager) install" 
		      WorkingDirectory="$(WebProjectPath)" 
		      Condition="!Exists('$(WebProjectPath)\node_modules')" 
		      ContinueOnError="true" />
		
		<!-- Build web project -->
		<Exec Command="$(WebPackageManager) $(WebBuildCommand)" 
		      WorkingDirectory="$(WebProjectPath)" 
		      ContinueOnError="false" />
		
		<Message Text="Web project build completed." Importance="high" />
	</Target>

	<!-- Copy web dist files to output directory/Web folder -->
	<Target Name="CopyWebFiles" AfterTargets="Build" Condition="Exists('$(WebDistPath)')">
		<PropertyGroup>
			<WebOutputDir>$(TargetDir)Web</WebOutputDir>
		</PropertyGroup>
		
		<!-- Delete existing Web folder before copying -->
		<RemoveDir Directories="$(WebOutputDir)" />
		
		<!-- Copy entire dist folder to Web folder -->
		<ItemGroup>
			<WebFiles Include="$(WebDistPath)\**\*.*" />
		</ItemGroup>
		
		<Copy SourceFiles="@(WebFiles)" 
		      DestinationFolder="$(WebOutputDir)\%(RecursiveDir)" />
	</Target>

	<!-- Copy dev server info file to output directory/Web folder (Debug mode only) -->
	<Target Name="CopyDevServerInfoFile" AfterTargets="Build" Condition="'$(Configuration)' == 'Debug' AND '$(WebProjectPath)' != ''">
		<PropertyGroup>
			<DevServerInfoSourcePath>$(WebProjectPath)\$(WebDevServerInfoFile)</DevServerInfoSourcePath>
			<DevServerInfoTargetPath>$(TargetDir)Web\$(WebDevServerInfoFile)</DevServerInfoTargetPath>
		</PropertyGroup>
		
		<Copy SourceFiles="$(DevServerInfoSourcePath)" 
		      DestinationFiles="$(DevServerInfoTargetPath)" 
		      Condition="Exists('$(DevServerInfoSourcePath)')"
		      SkipUnchangedFiles="true" />
	</Target>
</Project>
