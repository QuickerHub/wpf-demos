<UserControl
    x:Class="BatchRenameTool.Controls.PopupHelpButton"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:avalonEdit="http://icsharpcode.net/sharpdevelop/avalonedit"
    xmlns:mdx="clr-namespace:MdXaml;assembly=MdXaml">
    <UserControl.Resources>

        <SolidColorBrush x:Key="CodeBlockBackgroundBrush" Color="#404040" />

        <!--  MdXaml Markdown Style - Using HandyControl colors  -->
        <Style x:Key="MdStyle" TargetType="{x:Type FlowDocument}">
            <Setter Property="TextAlignment" Value="Left" />
            <Setter Property="FontSize" Value="13" />
            <Setter Property="Foreground" Value="{DynamicResource PrimaryTextBrush}" />
            <Setter Property="FontFamily" Value="Segoe UI, Microsoft YaHei, sans-serif" />
            <Setter Property="PagePadding" Value="10" />

            <Style.Resources>
                <!--  Quote block style  -->
                <Style TargetType="{x:Type Section}">
                    <Setter Property="Margin" Value="0,10" />
                    <Setter Property="Padding" Value="10,0" />
                    <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}" />
                    <Setter Property="BorderThickness" Value="2.5,0,0,0" />
                </Style>

                <!--  Code block style  -->
                <Style TargetType="{x:Type avalonEdit:TextEditor}">
                    <Setter Property="avalonEdit:TextEditor.HorizontalScrollBarVisibility" Value="Disabled" />
                    <Setter Property="avalonEdit:TextEditor.VerticalScrollBarVisibility" Value="Auto" />
                    <Setter Property="WordWrap" Value="True" />
                    <Setter Property="Background" Value="{DynamicResource CodeBlockBackgroundBrush}" />
                    <Setter Property="Foreground" Value="{DynamicResource PrimaryTextBrush}" />
                    <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}" />
                    <Setter Property="BorderThickness" Value="1" />
                    <Setter Property="Padding" Value="5,10" />
                    <Setter Property="Border.CornerRadius" Value="5" />
                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="{x:Type avalonEdit:TextEditor}">
                                <Border
                                    Background="{TemplateBinding Background}"
                                    BorderBrush="{TemplateBinding BorderBrush}"
                                    BorderThickness="{TemplateBinding BorderThickness}"
                                    CornerRadius="{TemplateBinding Border.CornerRadius}">
                                    <ScrollViewer
                                        Name="PART_ScrollViewer"
                                        Padding="{TemplateBinding Padding}"
                                        HorizontalContentAlignment="Left"
                                        VerticalContentAlignment="Top"
                                        CanContentScroll="True"
                                        Content="{Binding RelativeSource={RelativeSource TemplatedParent}, Path=TextArea}"
                                        Focusable="False"
                                        HorizontalScrollBarVisibility="Disabled"
                                        VerticalScrollBarVisibility="{TemplateBinding VerticalScrollBarVisibility}" />
                                </Border>
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                </Style>

                <!--  Headings and paragraphs  -->
                <Style TargetType="{x:Type Paragraph}">
                    <Setter Property="Margin" Value="0,6" />
                    <Setter Property="Foreground" Value="{DynamicResource PrimaryTextBrush}" />
                    <Style.Triggers>
                        <Trigger Property="FrameworkContentElement.Tag" Value="Heading1">
                            <Setter Property="Block.Margin" Value="0,10,0,0" />
                            <Setter Property="TextElement.Foreground" Value="{DynamicResource PrimaryTextBrush}" />
                            <Setter Property="TextElement.FontSize" Value="18" />
                            <Setter Property="TextElement.FontWeight" Value="Bold" />
                        </Trigger>
                        <Trigger Property="FrameworkContentElement.Tag" Value="Heading2">
                            <Setter Property="TextElement.Foreground" Value="{DynamicResource PrimaryTextBrush}" />
                            <Setter Property="TextElement.FontSize" Value="16" />
                            <Setter Property="TextElement.FontWeight" Value="Bold" />
                        </Trigger>
                        <Trigger Property="FrameworkContentElement.Tag" Value="Heading3">
                            <Setter Property="TextElement.Foreground" Value="{DynamicResource PrimaryTextBrush}" />
                            <Setter Property="TextElement.FontSize" Value="14" />
                            <Setter Property="TextElement.FontWeight" Value="Bold" />
                        </Trigger>
                        <Trigger Property="FrameworkContentElement.Tag" Value="Heading4">
                            <Setter Property="Block.Margin" Value="0,5,5,0" />
                            <Setter Property="TextElement.Foreground" Value="{DynamicResource PrimaryTextBrush}" />
                            <Setter Property="TextElement.FontSize" Value="13" />
                            <Setter Property="TextElement.FontWeight" Value="Bold" />
                        </Trigger>
                        <Trigger Property="FrameworkContentElement.Tag" Value="CodeBlock">
                            <Setter Property="TextElement.FontFamily" Value="Consolas, 'Courier New', monospace" />
                            <Setter Property="TextElement.FontSize" Value="12" />
                            <Setter Property="TextElement.Background" Value="{DynamicResource CodeBlockBackgroundBrush}" />
                            <Setter Property="TextElement.Foreground" Value="{DynamicResource PrimaryTextBrush}" />
                            <Setter Property="Block.Padding" Value="20,10" />
                        </Trigger>
                    </Style.Triggers>
                </Style>

                <!--  Inline code style - Enhanced visibility for dark mode  -->
                <Style TargetType="{x:Type Run}">
                    <Style.Triggers>
                        <Trigger Property="FrameworkContentElement.Tag" Value="CodeSpan">
                            <Setter Property="TextElement.FontFamily" Value="Consolas, 'Courier New', monospace" />
                            <Setter Property="TextElement.FontSize" Value="12" />
                            <!--  Use custom background color for better visibility  -->
                            <Setter Property="TextElement.Background" Value="{DynamicResource CodeBlockBackgroundBrush}" />
                            <Setter Property="TextElement.Foreground" Value="{DynamicResource PrimaryTextBrush}" />
                            <Setter Property="TextElement.FontWeight" Value="Normal" />
                        </Trigger>
                    </Style.Triggers>
                </Style>

                <!--  Hyperlink style  -->
                <Style TargetType="{x:Type Hyperlink}">
                    <Setter Property="Inline.TextDecorations" Value="None" />
                    <Setter Property="Foreground" Value="{DynamicResource PrimaryBrush}" />
                    <Style.Triggers>
                        <Trigger Property="IsMouseOver" Value="True">
                            <Setter Property="Foreground" Value="{DynamicResource InfoBrush}" />
                        </Trigger>
                    </Style.Triggers>
                </Style>

                <!--  List style  -->
                <Style TargetType="{x:Type List}">
                    <Setter Property="Margin" Value="0,5" />
                </Style>

                <!--  Table style  -->
                <Style TargetType="{x:Type Table}">
                    <Setter Property="Table.CellSpacing" Value="0" />
                    <Setter Property="Block.BorderThickness" Value="0.3" />
                    <Setter Property="Background" Value="{DynamicResource RegionBrush}" />
                    <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}" />
                    <Style.Resources>
                        <Style TargetType="{x:Type TableCell}">
                            <Setter Property="TableCell.BorderThickness" Value="0.2" />
                            <Setter Property="TableCell.BorderBrush" Value="{DynamicResource BorderBrush}" />
                            <Setter Property="TableCell.Padding" Value="13,6" />
                        </Style>
                    </Style.Resources>
                </Style>

                <!--  Table header style  -->
                <Style TargetType="{x:Type TableRowGroup}">
                    <Style.Triggers>
                        <Trigger Property="FrameworkContentElement.Tag" Value="TableHeader">
                            <Setter Property="TextElement.FontWeight" Value="Bold" />
                            <Setter Property="TextElement.Background" Value="{DynamicResource SecondaryRegionBrush}" />
                        </Trigger>
                    </Style.Triggers>
                </Style>
            </Style.Resources>
        </Style>

        <!--  Apply MdStyle to MarkdownScrollViewer  -->
        <Style TargetType="{x:Type mdx:MarkdownScrollViewer}">
            <Setter Property="MarkdownStyle" Value="{StaticResource MdStyle}" />
            <Setter Property="Background" Value="Transparent" />
        </Style>
    </UserControl.Resources>
    <Grid>
        <Button
            x:Name="HelpButton"
            Padding="10,5"
            Click="HelpButton_Click"
            Content="❓ 帮助"
            ToolTip="查看使用帮助" />
        <Popup
            x:Name="HelpPopup"
            MaxHeight="700"
            AllowsTransparency="True"
            Placement="Bottom"
            PlacementTarget="{Binding ElementName=HelpButton}"
            PopupAnimation="Fade"
            StaysOpen="False">
            <Border
                Padding="0"
                Background="{DynamicResource RegionBrush}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="1"
                CornerRadius="4">
                <Border.Effect>
                    <DropShadowEffect
                        BlurRadius="10"
                        Opacity="0.3"
                        ShadowDepth="3"
                        Color="Black" />
                </Border.Effect>
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <!--  Title  -->
                    <Border
                        Grid.Row="0"
                        Padding="15,12"
                        Background="{DynamicResource SecondaryRegionBrush}"
                        BorderBrush="{DynamicResource BorderBrush}"
                        BorderThickness="0,0,0,1">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            <TextBlock
                                Grid.Column="0"
                                VerticalAlignment="Center"
                                FontSize="16"
                                FontWeight="Bold"
                                Foreground="{DynamicResource PrimaryTextBrush}"
                                Text="{Binding Title, RelativeSource={RelativeSource AncestorType=UserControl}}" />
                            <Button
                                x:Name="CloseButton"
                                Grid.Column="1"
                                Padding="5,2"
                                Background="Transparent"
                                BorderThickness="0"
                                Click="CloseButton_Click"
                                Content="✕"
                                Cursor="Hand"
                                FontSize="14"
                                Foreground="{DynamicResource PrimaryTextBrush}"
                                ToolTip="关闭" />
                        </Grid>
                    </Border>

                    <!--  Content - Markdown  -->
                    <mdx:MarkdownScrollViewer
                        x:Name="MarkdownViewer"
                        Grid.Row="1"
                        MaxHeight="600"
                        Padding="20"
                        Background="Transparent"
                        Markdown="{Binding MarkdownContent, RelativeSource={RelativeSource AncestorType=UserControl}}"
                        PreviewMouseWheel="MarkdownViewer_PreviewMouseWheel" />
                </Grid>
            </Border>
        </Popup>
    </Grid>
</UserControl>
