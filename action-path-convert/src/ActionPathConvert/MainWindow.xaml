<Window
    x:Class="ActionPathConvert.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:controls="clr-namespace:ActionPathConvert.Controls"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:hc="https://handyorg.github.io/handycontrol"
    xmlns:local="clr-namespace:ActionPathConvert"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    Title="{Binding ViewModel.Title}"
    Width="1200"
    Height="800"
    d:DataContext="{d:DesignInstance local:MainWindow,
                                     IsDesignTimeCreatable=True}"
    d:DesignHeight="800"
    d:DesignWidth="1200"
    WindowStartupLocation="CenterScreen"
    mc:Ignorable="d">
    <Grid Margin="16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!--  Header  -->
        <TextBlock
            Grid.Row="0"
            Margin="0,0,0,16"
            FontSize="24"
            FontWeight="Bold"
            Foreground="{DynamicResource PrimaryTextBrush}"
            Text="{Binding ViewModel.Title}" />

        <!--  Configuration Panel  -->
        <GroupBox
            Grid.Row="1"
            Margin="0,0,0,16"
            Header="配置参数">
            <StackPanel Margin="8">
                <!--  Search Directory - 单独一行  -->
                <StackPanel Margin="0,0,0,8" Orientation="Horizontal">
                    <TextBlock
                        Margin="0,0,8,0"
                        VerticalAlignment="Center"
                        Text="目标目录：" />
                    <TextBox
                        Margin="0,0,8,0"
                        VerticalAlignment="Center"
                        Text="{Binding ViewModel.SearchDirectory, UpdateSourceTrigger=PropertyChanged}" />
                    <Button
                        Margin="0,0,16,0"
                        Padding="10,5"
                        Command="{Binding ViewModel.SelectSearchDirectoryCommand}"
                        Content="浏览..." />
                    <CheckBox
                        VerticalAlignment="Center"
                        Content="使用相对路径（相对于目标目录）"
                        IsChecked="{Binding ViewModel.UseRelativePath, UpdateSourceTrigger=PropertyChanged}" />
                </StackPanel>

                <!--  Audio Extensions and Preferred Extension  -->
                <Grid Margin="0,0,0,0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>
                    <TextBlock
                        Grid.Column="0"
                        Margin="0,0,8,0"
                        VerticalAlignment="Center"
                        Text="音频扩展名：" />
                    <TextBox
                        Grid.Column="1"
                        Margin="0,0,8,0"
                        Text="{Binding ViewModel.AudioExtensions, UpdateSourceTrigger=PropertyChanged}" />
                    <TextBlock
                        Grid.Column="2"
                        Margin="0,0,8,0"
                        VerticalAlignment="Center"
                        Text="优先扩展名：" />
                    <TextBox Grid.Column="3" Text="{Binding ViewModel.PreferredExtension, UpdateSourceTrigger=PropertyChanged}" />
                </Grid>
            </StackPanel>
        </GroupBox>

        <!--  Main Content  -->
        <Grid Grid.Row="2">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="5" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>

            <!--  Left: Input Files  -->
            <GroupBox Grid.Column="0" Header="输入文件列表">
                <Grid Margin="8">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <!--  Buttons  -->
                    <StackPanel
                        Grid.Row="0"
                        Margin="0,0,0,8"
                        Orientation="Horizontal">
                        <Button
                            Margin="0,0,8,0"
                            Padding="10,5"
                            Command="{Binding ViewModel.AddFilesCommand}"
                            Content="添加文件" />
                        <Button
                            Margin="0,0,8,0"
                            Padding="10,5"
                            Command="{Binding ViewModel.PasteFilesCommand}"
                            Content="粘贴文件" />
                        <Button
                            Margin="0,0,8,0"
                            Padding="10,5"
                            Click="RemoveSelectedFilesButton_Click"
                            Content="移除选中" />
                        <Button
                            Margin="0,0,8,0"
                            Padding="10,5"
                            Command="{Binding ViewModel.RemoveProcessedFilesCommand}"
                            Content="移除已处理" />
                        <Button
                            Padding="10,5"
                            Command="{Binding ViewModel.ClearFilesCommand}"
                            Content="清空" />
                    </StackPanel>

                    <!--  File List  -->
                    <ListBox
                        x:Name="InputFilesListBox"
                        Grid.Row="1"
                        ItemsSource="{Binding ViewModel.InputFiles}"
                        SelectionChanged="InputFilesListBox_SelectionChanged"
                        SelectionMode="Extended" />
                </Grid>
            </GroupBox>

            <!--  Splitter  -->
            <GridSplitter
                Grid.Column="1"
                HorizontalAlignment="Stretch"
                Background="{DynamicResource BorderBrush}" />

            <!--  Right: Preview  -->
            <GroupBox Grid.Column="2" Header="预览">
                <controls:PathPreviewControl AfterText="{Binding ViewModel.ProcessedFileContent}" BeforeText="{Binding ViewModel.SelectedFileContent}" />
            </GroupBox>
        </Grid>

        <!--  Bottom: Action Buttons and Results  -->
        <Grid Grid.Row="3" Margin="0,16,0,0">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <!--  Process Button  -->
            <Button
                Grid.Row="0"
                HorizontalAlignment="Center"
                Command="{Binding ViewModel.ProcessFilesCommand}"
                Content="处理文件"
                FontSize="14"
                FontWeight="Bold" />

            <!--  Status Message  -->
            <TextBlock
                Grid.Row="1"
                Margin="0,8,0,0"
                Foreground="{DynamicResource PrimaryTextBrush}"
                Text="{Binding ViewModel.StatusMessage}"
                TextWrapping="Wrap" />

            <!--  Results  -->
            <Grid
                Grid.Row="2"
                MaxHeight="200"
                Margin="0,16,0,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="5" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>

                <!--  Process Results List  -->
                <GroupBox Grid.Column="0" Header="处理结果">
                    <ListBox
                        x:Name="OutputFilesListBox"
                        Margin="8"
                        ItemsSource="{Binding ViewModel.ProcessResults}"
                        ScrollViewer.CanContentScroll="False"
                        SelectionChanged="OutputFilesListBox_SelectionChanged"
                        SelectionMode="Single">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <StackPanel>
                                    <!--  M3U File Path  -->
                                    <TextBlock
                                        FontWeight="Bold"
                                        Foreground="{DynamicResource PrimaryTextBrush}"
                                        Text="{Binding DisplayName}"
                                        ToolTip="{Binding M3uFilePath}" />
                                    <!--  Not Found Files  -->
                                    <ItemsControl Margin="16,4,0,0" ItemsSource="{Binding NotFoundFiles}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock FontSize="11" Foreground="{DynamicResource SecondaryTextBrush}">
                                                    <Run Text="  • " />
                                                    <Run Text="{Binding Path=.}" />
                                                </TextBlock>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </StackPanel>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </GroupBox>

                <!--  Splitter  -->
                <GridSplitter
                    Grid.Column="1"
                    HorizontalAlignment="Stretch"
                    Background="{DynamicResource BorderBrush}" />

                <!--  Process Result Display  -->
                <GroupBox Grid.Column="2" Header="处理结果详情">
                    <controls:ProcessResultControl x:Name="ProcessResultDisplay" ProcessResult="{Binding ViewModel.SelectedProcessResult}" />
                </GroupBox>
            </Grid>
        </Grid>
    </Grid>
</Window>
