# 软件更新方案调研

## 需求
- 支持 zip 下载
- 支持差分下载（只下载变更的文件）
- 减少重复下载（依赖很多，但大部分不变）
- 按文件 MD5 校验，只更新需要更新的文件

## 现有方案对比

### 1. Squirrel.Windows ⭐⭐⭐⭐
**GitHub**: https://github.com/Squirrel/Squirrel.Windows

**特点**：
- 专为 Windows 应用设计
- 支持增量更新（delta packages）
- 自动生成和应用差分包
- 支持 zip 格式
- 内置回滚机制
- 需要 GitHub Releases 或自定义服务器

**优点**：
- 成熟稳定，被很多知名应用使用（Slack, Discord 等）
- 自动处理版本管理和更新流程
- 支持后台更新和静默安装

**缺点**：
- 主要面向 Electron 和 .NET 应用
- 需要按照 Squirrel 的目录结构组织文件
- 学习曲线较陡

**适用场景**：适合需要完整更新框架的应用

---

### 2. AutoUpdater.NET ⭐⭐⭐
**GitHub**: https://github.com/ravibpatel/AutoUpdater.NET

**特点**：
- 轻量级 .NET 自动更新库
- 支持 XML 配置更新信息
- 支持 zip 下载和解压
- 简单易用

**优点**：
- 集成简单，几行代码即可
- 支持自定义更新服务器
- 支持更新前/后事件

**缺点**：
- **不支持增量更新**（只能全量下载）
- 功能相对简单
- 需要自己实现文件校验逻辑

**适用场景**：适合简单应用，不需要增量更新

---

### 3. ClickOnce ⭐⭐⭐
**微软官方技术**

**特点**：
- 微软官方部署技术
- 支持增量更新（只下载变更的文件）
- 自动处理依赖关系
- 内置版本管理

**优点**：
- 官方支持，稳定可靠
- 自动处理文件差异检测
- 支持在线和离线部署

**缺点**：
- 部署方式受限（需要 IIS 或文件服务器）
- 更新包格式固定
- 不适合所有场景

**适用场景**：适合企业内网部署

---

### 4. 二进制差分工具 + 自定义实现 ⭐⭐⭐⭐⭐

#### 4.1 bsdiff/bspatch
**工具**：bsdiff (生成差分) + bspatch (应用差分)

**特点**：
- 生成二进制差分包
- 差分包通常比完整文件小很多
- 跨平台支持

**实现方式**：
```bash
# 生成差分包
bsdiff old.exe new.exe patch.diff

# 应用差分包
bspatch old.exe new.exe patch.diff
```

**优点**：
- 差分包非常小（通常只有变更部分的 10-20%）
- 适合大文件更新
- 开源免费

**缺点**：
- 需要为每个文件生成差分包
- 需要管理多个差分包
- 只适合单个文件，不适合多文件依赖

#### 4.2 xdelta3
**工具**：xdelta3

**特点**：
- 类似 bsdiff，但支持更多格式
- 支持 VCDIFF 格式

---

### 5. 自定义实现（基于 MD5 校验）⭐⭐⭐⭐⭐

**实现思路**：
1. **服务器端**：
   - 维护所有文件的清单（manifest.json），包含文件路径、MD5、大小
   - 提供文件下载接口（支持单个文件或 zip 打包）
   - 提供清单查询接口

2. **客户端**：
   - 获取服务器清单
   - 计算本地文件 MD5
   - 对比差异，生成需要更新的文件列表
   - 下载差异文件（可打包成 zip）
   - 替换文件并验证

**优点**：
- **完全可控**，按需定制
- 支持按文件粒度更新
- 可以优化下载策略（并行下载、断点续传）
- 不依赖第三方框架

**缺点**：
- 需要自己实现所有逻辑
- 需要处理各种边界情况（文件锁定、权限等）

**实现示例结构**：
```
manifest.json:
{
  "version": "1.0.7",
  "files": [
    {
      "path": "libs/Newtonsoft.Json.dll",
      "md5": "abc123...",
      "size": 1234567,
      "url": "https://cdn.example.com/files/abc123.dll"
    },
    ...
  ]
}
```

---

## 推荐方案

### 方案 A：自定义实现（推荐）⭐⭐⭐⭐⭐
**适合你的场景**：
- 依赖很多，但大部分不变
- 需要精确控制更新流程
- 已经有自己的服务器/CDN

**实现要点**：
1. 使用 MD5/SHA256 校验文件
2. 支持 zip 打包下载（减少 HTTP 请求）
3. 支持并行下载和断点续传
4. 提供更新进度和错误处理

**技术栈**：
- `System.Security.Cryptography` (MD5/SHA256)
- `System.IO.Compression` (Zip)
- `HttpClient` (下载)
- `Newtonsoft.Json` (清单解析)

### 方案 B：Squirrel.Windows
**适合场景**：
- 需要完整的更新框架
- 愿意按照 Squirrel 的规范组织文件
- 需要自动回滚等高级功能

### 方案 C：混合方案
**结合使用**：
- 使用 bsdiff 处理大文件（如主程序 exe）
- 使用 MD5 校验处理依赖 DLL
- 小文件直接下载，大文件使用差分包

---

## 实现建议

### 如果选择自定义实现，建议的架构：

```
UpdateService
├── ManifestService (清单管理)
│   ├── GetServerManifest() - 获取服务器清单
│   └── CompareManifests() - 对比差异
├── DownloadService (下载管理)
│   ├── DownloadFile() - 单文件下载
│   ├── DownloadZip() - zip 下载
│   └── DownloadParallel() - 并行下载
├── VerificationService (校验服务)
│   ├── CalculateMD5() - 计算 MD5
│   └── VerifyFile() - 验证文件
└── UpdateService (更新服务)
    ├── CheckForUpdates() - 检查更新
    ├── DownloadUpdates() - 下载更新
    └── ApplyUpdates() - 应用更新
```

### 优化建议：
1. **清单缓存**：缓存服务器清单，减少请求
2. **增量清单**：只返回变更文件的清单
3. **CDN 加速**：使用 CDN 分发文件
4. **压缩传输**：zip 打包减少传输量
5. **断点续传**：支持大文件断点续传
6. **并行下载**：多文件并行下载提升速度

---

## 结论

**推荐使用自定义实现**，因为：
1. 你的需求很明确（MD5 校验 + zip 下载）
2. 依赖管理需要精确控制
3. 现有框架可能过度设计或不符合需求
4. 实现成本不高，但灵活性最高

**实现优先级**：
1. ✅ 基础功能（清单 + MD5 校验 + 文件下载）
2. ✅ Zip 打包下载
3. ✅ 并行下载和进度显示
4. ⚠️ 断点续传（可选）
5. ⚠️ bsdiff 大文件差分（可选，如果主程序很大）

