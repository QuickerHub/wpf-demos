<Page
    x:Class="QuickerExpressionAgent.Desktop.Pages.TestPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="clr-namespace:QuickerExpressionAgent.Desktop.Pages"
    xmlns:localConverters="clr-namespace:QuickerExpressionAgent.Desktop"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
    Title="API 测试"
    d:DataContext="{d:DesignInstance local:TestPage,
                                     IsDesignTimeCreatable=False}"
    Foreground="{DynamicResource TextFillColorPrimaryBrush}"
    mc:Ignorable="d">
    <Page.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis" />
        <localConverters:InvertBooleanConverter x:Key="InvertBooleanConverter" />
    </Page.Resources>
    <Grid Margin="16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!--  Status Card  -->
        <GroupBox
            Grid.Row="0"
            Margin="0,0,0,12"
            Header="状态">
            <StackPanel Margin="12" Orientation="Horizontal">
                <Ellipse
                    Width="12"
                    Height="12"
                    Margin="0,0,12,0"
                    Fill="#4CAF50" />
                <TextBlock
                    VerticalAlignment="Center"
                    FontSize="14"
                    Text="{Binding ViewModel.StatusText}" />
            </StackPanel>
        </GroupBox>

        <!--  Test Inputs Card  -->
        <GroupBox
            Grid.Row="1"
            Margin="0,0,0,12"
            Header="测试输入">
            <StackPanel Margin="12">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="100" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>

                    <TextBlock
                        Grid.Row="0"
                        Grid.Column="0"
                        Margin="0,0,12,12"
                        VerticalAlignment="Center"
                        Text="Handler ID:" />
                    <ui:TextBox
                        Grid.Row="0"
                        Grid.Column="1"
                        Margin="0,0,0,12"
                        Text="{Binding ViewModel.HandlerId, UpdateSourceTrigger=PropertyChanged}"
                        ToolTip="standalone" />

                    <TextBlock
                        Grid.Row="1"
                        Grid.Column="0"
                        Margin="0,0,12,12"
                        VerticalAlignment="Center"
                        Text="表达式:" />
                    <ui:TextBox
                        Grid.Row="1"
                        Grid.Column="1"
                        Margin="0,0,0,12"
                        Text="{Binding ViewModel.TestExpression, UpdateSourceTrigger=PropertyChanged}"
                        ToolTip="输入测试表达式" />

                    <TextBlock
                        Grid.Row="2"
                        Grid.Column="0"
                        Margin="0,0,12,12"
                        VerticalAlignment="Center"
                        Text="变量名:" />
                    <ui:TextBox
                        Grid.Row="2"
                        Grid.Column="1"
                        Margin="0,0,0,12"
                        Text="{Binding ViewModel.TestVariableName, UpdateSourceTrigger=PropertyChanged}"
                        ToolTip="变量名称" />

                    <TextBlock
                        Grid.Row="3"
                        Grid.Column="0"
                        Margin="0,0,12,12"
                        VerticalAlignment="Center"
                        Text="变量类型:" />
                    <ComboBox
                        Grid.Row="3"
                        Grid.Column="1"
                        Margin="0,0,0,12"
                        DisplayMemberPath="."
                        ItemsSource="{Binding ViewModel.VariableTypes}"
                        SelectedItem="{Binding ViewModel.SelectedVariableType}" />

                    <TextBlock
                        Grid.Row="4"
                        Grid.Column="0"
                        Margin="0,0,12,0"
                        VerticalAlignment="Center"
                        Text="变量值:" />
                    <ui:TextBox
                        Grid.Row="4"
                        Grid.Column="1"
                        Text="{Binding ViewModel.TestVariableValue, UpdateSourceTrigger=PropertyChanged}"
                        ToolTip="变量值（支持 JSON 格式）" />
                </Grid>
            </StackPanel>
        </GroupBox>

        <!--  Test Variables JSON Card  -->
        <GroupBox
            Grid.Row="2"
            Margin="0,0,0,12"
            Header="测试变量 JSON（用于 TestExpression）">
            <StackPanel Margin="12">
                <Grid Margin="0,0,0,12">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    <ui:Button
                        Grid.Column="1"
                        Margin="8,0,8,0"
                        Padding="8,4"
                        Command="{Binding ViewModel.LoadTestVariablesFromJsonCommand}"
                        Content="加载" />
                    <ui:Button
                        Grid.Column="2"
                        Padding="8,4"
                        Command="{Binding ViewModel.ExportVariablesToJsonCommand}"
                        Content="导出" />
                </Grid>
                <ui:TextBox
                    MinHeight="80"
                    MaxHeight="150"
                    AcceptsReturn="True"
                    FontFamily="Consolas"
                    FontSize="12"
                    Text="{Binding ViewModel.TestVariablesJson, UpdateSourceTrigger=PropertyChanged}"
                    TextWrapping="Wrap"
                    ToolTip="[{&quot;VarName&quot;:&quot;var1&quot;,&quot;VarType&quot;:&quot;String&quot;,&quot;DefaultValue&quot;:&quot;value1&quot;},...]"
                    VerticalScrollBarVisibility="Auto" />
            </StackPanel>
        </GroupBox>

        <!--  Test Buttons Card  -->
        <GroupBox
            Grid.Row="3"
            Margin="0,0,0,12"
            Header="API 测试">
            <StackPanel Margin="12">
                <StackPanel>
                    <UniformGrid Margin="0,0,0,8" Columns="2">
                        <!--  Handler Operations  -->
                        <ui:Button
                            MinHeight="36"
                            Margin="0,0,8,8"
                            Padding="8,6"
                            HorizontalAlignment="Stretch"
                            HorizontalContentAlignment="Center"
                            VerticalContentAlignment="Center"
                            Command="{Binding ViewModel.TestGetOrCreateCodeEditorCommand}"
                            IsEnabled="{Binding ViewModel.CanTest}">
                            <TextBlock
                                Text="GetOrCreateCodeEditorAsync"
                                TextAlignment="Center"
                                TextWrapping="Wrap" />
                        </ui:Button>
                        <ui:Button
                            MinHeight="36"
                            Margin="8,0,0,8"
                            Padding="8,6"
                            HorizontalAlignment="Stretch"
                            HorizontalContentAlignment="Center"
                            VerticalContentAlignment="Center"
                            Command="{Binding ViewModel.TestGetCodeWrapperIdCommand}"
                            IsEnabled="{Binding ViewModel.CanTest}">
                            <TextBlock
                                Text="GetCodeWrapperIdAsync"
                                TextAlignment="Center"
                                TextWrapping="Wrap" />
                        </ui:Button>

                        <!--  Wrapper Operations (Require Code Editor Handler)  -->
                        <ui:Button
                            MinHeight="36"
                            Margin="0,0,8,8"
                            Padding="8,6"
                            HorizontalAlignment="Stretch"
                            HorizontalContentAlignment="Center"
                            VerticalContentAlignment="Center"
                            Command="{Binding ViewModel.TestGetExpressionAndVariablesCommand}"
                            IsEnabled="{Binding ViewModel.HasCodeEditorHandler}">
                            <TextBlock
                                Text="GetExpressionAndVariablesForWrapperAsync"
                                TextAlignment="Center"
                                TextWrapping="Wrap" />
                        </ui:Button>
                        <ui:Button
                            MinHeight="36"
                            Margin="8,0,0,8"
                            Padding="8,6"
                            HorizontalAlignment="Stretch"
                            HorizontalContentAlignment="Center"
                            VerticalContentAlignment="Center"
                            Command="{Binding ViewModel.TestSetExpressionForWrapperCommand}"
                            IsEnabled="{Binding ViewModel.HasCodeEditorHandler}">
                            <TextBlock
                                Text="SetExpressionForWrapperAsync"
                                TextAlignment="Center"
                                TextWrapping="Wrap" />
                        </ui:Button>

                        <!--  Variable Operations (Require Code Editor Handler)  -->
                        <ui:Button
                            MinHeight="36"
                            Margin="0,0,8,8"
                            Padding="8,6"
                            HorizontalAlignment="Stretch"
                            HorizontalContentAlignment="Center"
                            VerticalContentAlignment="Center"
                            Command="{Binding ViewModel.TestGetVariableCommand}"
                            IsEnabled="{Binding ViewModel.HasCodeEditorHandler}">
                            <TextBlock
                                Text="GetVariableForWrapperAsync"
                                TextAlignment="Center"
                                TextWrapping="Wrap" />
                        </ui:Button>
                        <ui:Button
                            MinHeight="36"
                            Margin="8,0,0,8"
                            Padding="8,6"
                            HorizontalAlignment="Stretch"
                            HorizontalContentAlignment="Center"
                            VerticalContentAlignment="Center"
                            Command="{Binding ViewModel.TestSetVariableCommand}"
                            IsEnabled="{Binding ViewModel.HasCodeEditorHandler}">
                            <TextBlock
                                Text="SetVariableForWrapperAsync"
                                TextAlignment="Center"
                                TextWrapping="Wrap" />
                        </ui:Button>
                        <ui:Button
                            MinHeight="36"
                            Margin="0,0,8,8"
                            Padding="8,6"
                            HorizontalAlignment="Stretch"
                            HorizontalContentAlignment="Center"
                            VerticalContentAlignment="Center"
                            Command="{Binding ViewModel.TestGetAllVariablesCommand}"
                            IsEnabled="{Binding ViewModel.HasCodeEditorHandler}">
                            <TextBlock
                                Text="GetAllVariables (详细)"
                                TextAlignment="Center"
                                TextWrapping="Wrap" />
                        </ui:Button>
                    </UniformGrid>

                    <!--  Test Expression (Require Code Editor Handler) - Full Width  -->
                    <ui:Button
                        MinHeight="36"
                        Padding="8,6"
                        HorizontalAlignment="Stretch"
                        HorizontalContentAlignment="Center"
                        VerticalContentAlignment="Center"
                        Command="{Binding ViewModel.TestTestExpressionForWrapperCommand}"
                        IsEnabled="{Binding ViewModel.HasCodeEditorHandler}">
                        <TextBlock
                            Text="TestExpressionForWrapperAsync"
                            TextAlignment="Center"
                            TextWrapping="Wrap" />
                    </ui:Button>
                </StackPanel>
            </StackPanel>
        </GroupBox>

        <!--  Test Result Card  -->
        <GroupBox Grid.Row="4" Header="测试结果">
            <StackPanel Margin="12">
                <ui:TextBox
                    MinHeight="100"
                    Padding="12"
                    BorderThickness="0"
                    FontFamily="Consolas"
                    FontSize="12"
                    IsReadOnly="True"
                    Text="{Binding ViewModel.TestResult, Mode=OneWay}"
                    TextWrapping="Wrap" />
            </StackPanel>
        </GroupBox>
    </Grid>
</Page>

